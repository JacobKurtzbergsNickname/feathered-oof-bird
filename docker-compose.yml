services:
  ooftish-postgres:
    image: postgres:17-alpine
    container_name: ooftish-postgres
    environment:
      POSTGRES_USER: ooftish-postgres
      POSTGRES_PASSWORD: Y0uYuM40D3Q14nN140!
      POSTGRES_DB: ooftish_postgres
    ports:
      - "5532:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - ooftish-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ooftish-postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  ooftish-mongo:
    image: mongo:7
    container_name: ooftish-mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: ooftish-mongo
      MONGO_INITDB_ROOT_PASSWORD: Y0uYuM40D3Q14nN140!
      MONGO_INITDB_DATABASE: ooftish_mongo
    ports:
      - "27020:27017"
    volumes:
      - mongodata:/data/db
    networks:
      - ooftish-network
    healthcheck:
      test: ["CMD", "mongosh", "--username", "ooftish-mongo", "--password", "Y0uYuM40D3Q14nN140!", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  ooftish-valkey:
    image: valkey/valkey:7.2-alpine
    container_name: ooftish-valkey
    command: ["valkey-server", "--requirepass", "Y0uYuM40D3Q14nN140!"]
    ports:
      - "6379:6379"
    volumes:
      - valkeydata:/data
    networks:
      - ooftish-network
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "Y0uYuM40D3Q14nN140!", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ooftish-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ooftish-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://ooftish-postgres:5532/ooftish_postgres
      SPRING_DATASOURCE_USERNAME: ooftish-postgres
      SPRING_DATASOURCE_PASSWORD: Y0uYuM40D3Q14nN140!
      SPRING_DATA_MONGODB_URI: mongodb://ooftish-mongo:Y0uYuM40D3Q14nN140!@ooftish-mongo:27017/ooftish_mongo
      SPRING_DATA_REDIS_HOST: ooftish-valkey
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: Y0uYuM40D3Q14nN140!
    depends_on:
      ooftish-postgres:
        condition: service_healthy
      ooftish-mongo:
        condition: service_healthy
      ooftish-valkey:
        condition: service_healthy
    networks:
      - ooftish-network
    profiles: ["prod"]

  ooftish-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ooftish-frontend
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:8080
    depends_on:
      - ooftish-backend
    networks:
      - ooftish-network
    profiles: ["prod"]

volumes:
  pgdata:
  mongodata:
  valkeydata:

networks:
  ooftish-network:
    driver: bridge
